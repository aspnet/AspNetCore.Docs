<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Response Caching Middleware in ASP.NET Core </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Response Caching Middleware in ASP.NET Core ">
    <meta name="generator" content="docfx 2.24.0.0">
    
    <link rel="shortcut icon" href="../../favicon.ico">
    <link rel="stylesheet" href="../../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../../styles/docfx.css">
    <link rel="stylesheet" href="../../styles/main.css">
    <meta property="docfx:navrel" content="/foo">
    <meta property="docfx:tocrel" content="../../toc.html">
    
    
    
  </head>
  <body data-spy="scroll" data-target="#affix">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../../index.html">
                <img id="logo" class="svg" src="../../logo.svg" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div role="main" class="container body-content hide-when-search">
        
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="performance/caching/middleware">
<h1 id="response-caching-middleware-in-aspnet-core">Response Caching Middleware in ASP.NET Core</h1>

<p>By <a href="https://github.com/guardrex">Luke Latham</a> and <a href="https://github.com/JunTaoLuo">John Luo</a></p>
<p><a href="https://github.com/aspnet/Docs/tree/master/aspnetcore/performance/caching/middleware/samples">View or download sample code</a></p>
<p>This document provides details on how to configure the Response Caching Middleware in ASP.NET Core apps. The middleware determines when responses are cacheable, stores responses, and serves responses from cache. For an introduction to HTTP caching and the <code>ResponseCache</code> attribute, see <a href="response.html">Response Caching</a>.</p>
<h2 id="package">Package</h2>
<p>To include the middleware in a project, add a reference to the <a href="https://www.nuget.org/packages/Microsoft.AspNetCore.ResponseCaching/"><code>Microsoft.AspNetCore.ResponseCaching</code></a> package or use the <a href="https://www.nuget.org/packages/Microsoft.AspNetCore.All/"><code>Microsoft.AspNetCore.All</code></a> package.</p>
<h2 id="configuration">Configuration</h2>
<p>In <code>ConfigureServices</code>, add the middleware to the service collection.</p>
<div class="tabGroup" id="tabgroup_mbhDMNLMZA">
<ul role="tablist">
<li role="presentation">
<a href="#tabpanel_mbhDMNLMZA_aspnetcore2x" role="tab" aria-controls="tabpanel_mbhDMNLMZA_aspnetcore2x" data-tab="aspnetcore2x" tabindex="0" aria-selected="true">ASP.NET Core 2.x</a>
</li>
<li role="presentation">
<a href="#tabpanel_mbhDMNLMZA_aspnetcore1x" role="tab" aria-controls="tabpanel_mbhDMNLMZA_aspnetcore1x" data-tab="aspnetcore1x" tabindex="-1">ASP.NET Core 1.x</a>
</li>
</ul>
<section id="tabpanel_mbhDMNLMZA_aspnetcore2x" role="tabpanel" data-tab="aspnetcore2x">
<pre><code class="lang-csharp" name="Main" highlight-lines="4">WebHost.CreateDefaultBuilder(args)
    .ConfigureServices(services =&gt;
    {
        services.AddResponseCaching();
    })
    .Configure(app =&gt;
    {
        app.UseResponseCaching();

        app.Run(async (context) =&gt;
        {
            context.Response.GetTypedHeaders().CacheControl = new CacheControlHeaderValue()
            {
                Public = true,
                MaxAge = TimeSpan.FromSeconds(10)
            };
            context.Response.Headers[HeaderNames.Vary] = new string[] { &quot;Accept-Encoding&quot; };

            await context.Response.WriteAsync($&quot;Hello World! {DateTime.UtcNow}&quot;);
        });
    })
    .Build();
</code></pre></section>
<section id="tabpanel_mbhDMNLMZA_aspnetcore1x" role="tabpanel" data-tab="aspnetcore1x" aria-hidden="true" hidden="hidden">
<pre><code class="lang-csharp" name="Main" highlight-lines="3">public void ConfigureServices(IServiceCollection services)
{
    services.AddResponseCaching();
}
</code></pre></section>
</div>
<p>Configure the app to use the middleware with the <code>UseResponseCaching</code> extension method, which adds the middleware to the request processing pipeline. The sample app adds a <a href="https://tools.ietf.org/html/rfc7234#section-5.2"><code>Cache-Control</code></a> header to the response that caches cacheable responses for up to 10 seconds. The sample sends a <a href="https://tools.ietf.org/html/rfc7231#section-7.1.4"><code>Vary</code></a> header to configure the middleware to serve a cached response only if the <a href="https://tools.ietf.org/html/rfc7231#section-5.3.4"><code>Accept-Encoding</code></a> header of subsequent requests matches that of the original request.</p>
<div class="tabGroup" id="tabgroup_mbhDMNLMZA-1">
<ul role="tablist">
<li role="presentation">
<a href="#tabpanel_mbhDMNLMZA-1_aspnetcore2x" role="tab" aria-controls="tabpanel_mbhDMNLMZA-1_aspnetcore2x" data-tab="aspnetcore2x" tabindex="0" aria-selected="true">ASP.NET Core 2.x</a>
</li>
<li role="presentation">
<a href="#tabpanel_mbhDMNLMZA-1_aspnetcore1x" role="tab" aria-controls="tabpanel_mbhDMNLMZA-1_aspnetcore1x" data-tab="aspnetcore1x" tabindex="-1">ASP.NET Core 1.x</a>
</li>
</ul>
<section id="tabpanel_mbhDMNLMZA-1_aspnetcore2x" role="tabpanel" data-tab="aspnetcore2x">
<pre><code class="lang-csharp" name="Main" highlight-lines="8">WebHost.CreateDefaultBuilder(args)
    .ConfigureServices(services =&gt;
    {
        services.AddResponseCaching();
    })
    .Configure(app =&gt;
    {
        app.UseResponseCaching();

        app.Run(async (context) =&gt;
        {
            context.Response.GetTypedHeaders().CacheControl = new CacheControlHeaderValue()
            {
                Public = true,
                MaxAge = TimeSpan.FromSeconds(10)
            };
            context.Response.Headers[HeaderNames.Vary] = new string[] { &quot;Accept-Encoding&quot; };

            await context.Response.WriteAsync($&quot;Hello World! {DateTime.UtcNow}&quot;);
        });
    })
    .Build();
</code></pre></section>
<section id="tabpanel_mbhDMNLMZA-1_aspnetcore1x" role="tabpanel" data-tab="aspnetcore1x" aria-hidden="true" hidden="hidden">
<pre><code class="lang-csharp" name="Main" highlight-lines="3">public void Configure(IApplicationBuilder app)
{
    app.UseResponseCaching();
    
    app.Run(async (context) =&gt;
    {
        context.Response.GetTypedHeaders().CacheControl = new CacheControlHeaderValue()
        {
            Public = true,
            MaxAge = TimeSpan.FromSeconds(10)
        };
        context.Response.Headers[HeaderNames.Vary] = new string[] { &quot;Accept-Encoding&quot; };

        await context.Response.WriteAsync($&quot;Hello World! {DateTime.UtcNow}&quot;);
    });
}
</code></pre></section>
</div>
<p>The Response Caching Middleware only caches 200 (OK) server responses. Any other responses, including <a class="xref" href="../../fundamentals/error-handling.html">error pages</a>, are ignored by the middleware.</p>
<div class="WARNING"><h5>Warning</h5><p>Responses containing content for authenticated clients must be marked as not cacheable to prevent the middleware from storing and serving those responses. See <a href="#conditions-for-caching">Conditions for caching</a> for details on how the middleware determines if a response is cacheable.</p>
</div>
<h2 id="options">Options</h2>
<p>The middleware offers three options for controlling response caching.</p>
<table>
<thead>
<tr>
<th>Option</th>
<th>Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>UseCaseSensitivePaths</td>
<td>Determines if responses are cached on case-sensitive paths.<p><p>The default value is <code>false</code>.</td>
</tr>
<tr>
<td>MaximumBodySize</td>
<td>The largest cacheable size for the response body in bytes.<p>The default value is <code>64 * 1024 * 1024</code> (64 MB).</td>
</tr>
<tr>
<td>SizeLimit</td>
<td>The size limit for the response cache middleware in bytes. The default value is <code>100 * 1024 * 1024</code> (100 MB).</td>
</tr>
</tbody>
</table>
<p>The following example configures the middleware to cache responses smaller than or equal to 1,024 bytes using case-sensitive paths, storing the responses to <code>/page1</code> and <code>/Page1</code> separately.</p>
<pre><code class="lang-csharp">services.AddResponseCaching(options =&gt;
{
    options.UseCaseSensitivePaths = true;
    options.MaximumBodySize = 1024;
});
</code></pre><h2 id="varybyquerykeys">VaryByQueryKeys</h2>
<p>When using MVC, the <code>ResponseCache</code> attribute specifies the parameters necessary for setting appropriate headers for response caching. The only parameter of the <code>ResponseCache</code> attribute that strictly requires the middleware is <code>VaryByQueryKeys</code>, which doesn&#39;t correspond to an actual HTTP header. For more information, see <a href="response.html#responsecache-attribute">ResponseCache Attribute</a>.</p>
<p>When not using MVC, you can vary response caching with the <code>VaryByQueryKeys</code> feature. Use the <code>ResponseCachingFeature</code> directly from the <code>IFeatureCollection</code> of the <code>HttpContext</code>:</p>
<pre><code class="lang-csharp">var responseCachingFeature = context.HttpContext.Features.Get&lt;IResponseCachingFeature&gt;();
if (responseCachingFeature != null)
{
    responseCachingFeature.VaryByQueryKeys = new[] { &quot;MyKey&quot; };
}
</code></pre><h2 id="http-headers-used-by-response-caching-middleware">HTTP headers used by Response Caching Middleware</h2>
<p>Response caching by the middleware is configured via HTTP headers. The relevant headers are listed below with notes on how they affect caching.</p>
<table>
<thead>
<tr>
<th>Header</th>
<th>Details</th>
</tr>
</thead>
<tbody>
<tr>
<td>Authorization</td>
<td>The response isn&#39;t cached if the header exists.</td>
</tr>
<tr>
<td>Cache-Control</td>
<td>The middleware only considers caching responses marked with the <code>public</code> cache directive. You can control caching with the following parameters:<ul><li>max-age</li><li>max-stale&#8224;</li><li>min-fresh</li><li>must-revalidate</li><li>no-cache</li><li>no-store</li><li>only-if-cached</li><li>private</li><li>public</li><li>s-maxage</li><li>proxy-revalidate&#8225;</li></ul>&#8224;If no limit is specified to <code>max-stale</code>, the middleware takes no action.<br>&#8225;<code>proxy-revalidate</code> has the same effect as <code>must-revalidate</code>.<br><br>For more information, see <a href="https://tools.ietf.org/html/rfc7234#section-5.2.1">RFC 7231: Request Cache-Control Directives</a>.</td>
</tr>
<tr>
<td>Pragma</td>
<td>A <code>Pragma: no-cache</code> header in the request produces the same effect as <code>Cache-Control: no-cache</code>. This header is overridden by the relevant directives in the <code>Cache-Control</code> header, if present. Considered for backward compatibility with HTTP/1.0.</td>
</tr>
<tr>
<td>Set-Cookie</td>
<td>The response isn&#39;t cached if the header exists.</td>
</tr>
<tr>
<td>Vary</td>
<td>The <code>Vary</code> header is used to vary the cached response by another header. For example, you can cache responses by encoding by including the <code>Vary: Accept-Encoding</code> header, which caches responses for requests with headers <code>Accept-Encoding: gzip</code> and <code>Accept-Encoding: text/plain</code> separately. A response with a header value of <code>*</code> is never stored.</td>
</tr>
<tr>
<td>Expires</td>
<td>A response deemed stale by this header isn&#39;t stored or retrieved unless overridden by other <code>Cache-Control</code> headers.</td>
</tr>
<tr>
<td>If-None-Match</td>
<td>The full response is served from cache if the value isn&#39;t <code>*</code> and the <code>ETag</code> of the response doesn&#39;t match any of the values provided. Otherwise, a 304 (Not Modified) response is served.</td>
</tr>
<tr>
<td>If-Modified-Since</td>
<td>If the <code>If-None-Match</code> header isn&#39;t present, a full response is served from cache if the cached response date is newer than the value provided. Otherwise, a 304 (Not Modified) response is served.</td>
</tr>
<tr>
<td>Date</td>
<td>When serving from cache, the <code>Date</code> header is set by the middleware if it wasn&#39;t provided on the original response.</td>
</tr>
<tr>
<td>Content-Length</td>
<td>When serving from cache, the <code>Content-Length</code> header is set by the middleware if it wasn&#39;t provided on the original response.</td>
</tr>
<tr>
<td>Age</td>
<td>The <code>Age</code> header sent in the original response is ignored. The middleware computes a new value when serving a cached response.</td>
</tr>
</tbody>
</table>
<h2 id="caching-respects-request-cache-control-directives">Caching respects request Cache-Control directives</h2>
<p>The middleware respects the rules of the <a href="https://tools.ietf.org/html/rfc7234#section-5.2">HTTP 1.1 Caching specification</a>. The rules require a cache to honor a valid <code>Cache-Control</code> header sent by the client. Under the specification, a client can make requests with a <code>no-cache</code> header value and force a server to generate a new response for every request. Currently, there&#39;s no developer control over this caching behavior when using the middleware because the middleware adheres to the official caching specification.</p>
<p><a href="https://github.com/aspnet/ResponseCaching/issues/96">Future enhancements to the middleware</a> will permit configuring the middleware for caching scenarios where the request <code>Cache-Control</code> header should be ignored when deciding to serve a cached response. If you seek more control over caching behavior, explore other caching features of ASP.NET Core. See the following topics:</p>
<ul>
<li><a class="xref" href="memory.html">Introduction to in-memory caching in ASP.NET Core</a></li>
<li><a class="xref" href="distributed.html">Working with a distributed cache</a></li>
<li><a class="xref" href="../../mvc/views/tag-helpers/built-in/cache-tag-helper.html">Cache Tag Helper in ASP.NET Core MVC</a></li>
<li><a class="xref" href="../../mvc/views/tag-helpers/built-in/distributed-cache-tag-helper.html">Distributed Cache Tag Helper</a></li>
</ul>
<h2 id="troubleshooting">Troubleshooting</h2>
<p>If caching behavior isn&#39;t as you expect, confirm that responses are cacheable and capable of being served from the cache by examining the request&#39;s incoming headers and the response&#39;s outgoing headers. Enabling <a class="xref" href="../../fundamentals/logging.html">logging</a> can help when debugging. The middleware logs caching behavior and when a response is retrieved from cache.</p>
<p>When testing and troubleshooting caching behavior, a browser may set request headers that affect caching in undesirable ways. For example, a browser may set the <code>Cache-Control</code> header to <code>no-cache</code> when you refresh the page. The following tools can explicitly set request headers, and are preferred for testing caching:</p>
<ul>
<li><a href="http://www.telerik.com/fiddler">Fiddler</a></li>
<li><a href="http://getfirebug.com/">Firebug</a></li>
<li><a href="https://www.getpostman.com/">Postman</a></li>
</ul>
<h3 id="conditions-for-caching">Conditions for caching</h3>
<ul>
<li>The request must result in a 200 (OK) response from the server.</li>
<li>The request method must be GET or HEAD.</li>
<li>Terminal middleware, such as Static File Middleware, must not process the response prior to the Response Caching Middleware.</li>
<li>The <code>Authorization</code> header must not be present.</li>
<li><code>Cache-Control</code> header parameters must be valid, and the response must be marked <code>public</code> and not marked <code>private</code>.</li>
<li>The <code>Pragma: no-cache</code> header/value must not be present if the <code>Cache-Control</code> header isn&#39;t present, as the <code>Cache-Control</code> header overrides the <code>Pragma</code> header when present.</li>
<li>The <code>Set-Cookie</code> header must not be present.</li>
<li><code>Vary</code> header parameters must be valid and not equal to <code>*</code>.</li>
<li>The <code>Content-Length</code> header value (if set) must match the size of the response body.</li>
<li>The <a href="/aspnet/core/api/microsoft.aspnetcore.http.features.ihttpsendfilefeature">IHttpSendFileFeature</a> isn&#39;t used.</li>
<li>The response must not be stale as specified by the <code>Expires</code> header and the <code>max-age</code> and <code>s-maxage</code> cache directives.</li>
<li>Response buffering is successful, and the size of the response is smaller than the configured or default <code>SizeLimit</code>.</li>
<li>The response must be cacheable according to the <a href="https://tools.ietf.org/html/rfc7234">RFC 7234</a> specifications. For example, the <code>no-store</code> directive must not exist in request or response header fields. See <em>Section 3: Storing Responses in Caches</em> of <a href="https://tools.ietf.org/html/rfc7234">RFC 7234</a> for details.</li>
</ul>
<div class="NOTE"><h5>Note</h5><p>The Antiforgery system for generating secure tokens to prevent Cross-Site Request Forgery (CSRF) attacks sets the <code>Cache-Control</code> and <code>Pragma</code> headers to <code>no-cache</code> so that responses aren&#39;t cached.</p>
</div>
<h2 id="additional-resources">Additional resources</h2>
<ul>
<li><a class="xref" href="../../fundamentals/startup.html">Application Startup</a></li>
<li><a class="xref" href="../../fundamentals/middleware.html">Middleware</a></li>
</ul>
</article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                  <li>
                    <a href="https://github.com/aspnet/Docs/blob/w/riande/RP-EF/aspnetcore/performance/caching/middleware.md/#L1" class="contribution-link">Improve this Doc</a>
                  </li>
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              <!-- <p><a class="back-to-top" href="#top">Back to top</a><p> -->
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            
            <span>Copyright © 2015-2017 Microsoft<br>Generated by <strong>DocFX</strong></span>
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../styles/main.js"></script>
  </body>
</html>
