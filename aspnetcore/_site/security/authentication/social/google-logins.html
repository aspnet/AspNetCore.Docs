<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Google external login setup in ASP.NET Core </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Google external login setup in ASP.NET Core ">
    <meta name="generator" content="docfx 2.24.0.0">
    
    <link rel="shortcut icon" href="../../../favicon.ico">
    <link rel="stylesheet" href="../../../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../../../styles/docfx.css">
    <link rel="stylesheet" href="../../../styles/main.css">
    <meta property="docfx:navrel" content="/foo">
    <meta property="docfx:tocrel" content="../../../toc.html">
    
    
    
  </head>
  <body data-spy="scroll" data-target="#affix">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../../../index.html">
                <img id="logo" class="svg" src="../../../logo.svg" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div role="main" class="container body-content hide-when-search">
        
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="security/authentication/google-logins">
<h1 id="configuring-google-authentication-in-aspnet-core">Configuring Google authentication in ASP.NET Core</h1>

<p><a name="security-authentication-google-logins"></a></p>
<p>By <a href="https://github.com/01binary">Valeriy Novytskyy</a> and <a href="https://twitter.com/RickAndMSFT">Rick Anderson</a></p>
<p>This tutorial shows you how to enable your users to sign in with their Google+ account using a sample ASP.NET Core 2.0 project created on the <a href="index.html">previous page</a>. We start by following the <a href="https://developers.google.com/identity/sign-in/web/devconsole-project">official steps</a> to create a new app in Google API Console.</p>
<h2 id="create-the-app-in-google-api-console">Create the app in Google API Console</h2>
<ul>
<li>Navigate to <a href="https://console.developers.google.com/projectselector/apis/library">https://console.developers.google.com/projectselector/apis/library</a> and sign in. If you don&#39;t already have a Google account, use <strong>More options</strong> &gt; <strong><a href="https://accounts.google.com/SignUpWithoutGmail?service=cloudconsole&amp;continue=https%3A%2F%2Fconsole.developers.google.com%2Fprojectselector%2Fapis%2Flibrary&amp;ltmpl=api">Create account</a></strong> link to create one:</li>
</ul>
<p><img src="index/_static/GoogleConsoleLogin.png" alt="Google API Console"></p>
<ul>
<li>You are redirected to <strong>API Manager Library</strong> page:</li>
</ul>
<p><img src="index/_static/GoogleConsoleSwitchboard.png" alt="API Manager Library page"></p>
<ul>
<li>Tap <strong>Create</strong> and enter your <strong>Project name</strong>:</li>
</ul>
<p><img src="index/_static/GoogleConsoleNewProj.png" alt="New Project dialog"></p>
<ul>
<li>After accepting the dialog, you are redirected back to the Library page allowing you to choose features for your new app. Find <strong>Google+ API</strong> in the list and click on its link to add the API feature:</li>
</ul>
<p><img src="index/_static/GoogleConsoleChooseApi.png" alt="API Manager Library page"></p>
<ul>
<li>The page for the newly added API is displayed. Tap <strong>Enable</strong> to add Google+ sign in feature to your app:</li>
</ul>
<p><img src="index/_static/GoogleConsoleEnableApi.png" alt="API Manager Google+API page"></p>
<ul>
<li>After enabling the API, tap <strong>Create credentials</strong> to configure the secrets:</li>
</ul>
<p><img src="index/_static/GoogleConsoleGoCredentials.png" alt="API Manager Google+API page"></p>
<ul>
<li>Choose:<ul>
<li><strong>Google+ API</strong></li>
<li><strong>Web server (e.g. node.js, Tomcat)</strong>, and</li>
<li><strong>User data</strong>:</li>
</ul>
</li>
</ul>
<p><img src="index/_static/GoogleConsoleChooseCred.png" alt="API Manager Credentials page: Find out what kind of credentials you need panel"></p>
<ul>
<li>Tap <strong>What credentials do I need?</strong> which takes you to the second step of app configuration, <strong>Create an OAuth 2.0 client ID</strong>:</li>
</ul>
<p><img src="index/_static/GoogleConsoleCreateClient.png" alt="API Manager Credentials page: Create an OAuth 2.0 client ID"></p>
<ul>
<li><p>Because we are creating a Google+ project with just one feature (sign in), we can enter the same <strong>Name</strong> for the OAuth 2.0 client ID as the one we used for the project.</p>
</li>
<li><p>Enter your development URI with <em>/signin-google</em> appended into the <strong>Authorized redirect URIs</strong> field (for example: <code>https://localhost:44320/signin-google</code>). The Google authentication configured later in this tutorial will automatically handle requests at <em>/signin-google</em> route to implement the OAuth flow.</p>
</li>
<li><p>Press TAB to add the <strong>Authorized redirect URIs</strong> entry.</p>
</li>
<li><p>Tap <strong>Create client ID</strong>, which takes you to the third step, <strong>Set up the OAuth 2.0 consent screen</strong>:</p>
</li>
</ul>
<p><img src="index/_static/GoogleConsoleAddCred.png" alt="API Manager Credentials page: Set up the OAuth 2.0 consent screen"></p>
<ul>
<li><p>Enter your public facing <strong>Email address</strong> and the <strong>Product name</strong> shown for your app when Google+ prompts the user to sign in. Additional options are available under <strong>More customization options</strong>.</p>
</li>
<li><p>Tap <strong>Continue</strong> to proceed to the last step, <strong>Download credentials</strong>:</p>
</li>
</ul>
<p><img src="index/_static/GoogleConsoleFinish.png" alt="API Manager Credentials page: Download credentials"></p>
<ul>
<li><p>Tap <strong>Download</strong> to save a JSON file with application secrets, and <strong>Done</strong> to complete creation of the new app.</p>
</li>
<li><p>When deploying the site you&#39;ll need to revisit the <strong>Google Console</strong> and register a new public url.</p>
</li>
</ul>
<h2 id="store-google-clientid-and-clientsecret">Store Google ClientID and ClientSecret</h2>
<p>Link sensitive settings like Google <code>Client ID</code> and <code>Client Secret</code> to your application configuration using the <a href="../../app-secrets.html">Secret Manager</a>. For the purposes of this tutorial, name the tokens <code>Authentication:Google:ClientId</code> and <code>Authentication:Google:ClientSecret</code>.</p>
<p>The values for these tokens can be found in the JSON file downloaded in the previous step under <code>web.client_id</code> and <code>web.client_secret</code>.</p>
<h2 id="configure-google-authentication">Configure Google Authentication</h2>
<p>The project template used in this tutorial ensures that <a href="https://www.nuget.org/packages/Microsoft.AspNetCore.Authentication.Google">Microsoft.AspNetCore.Authentication.Google</a> package is installed.</p>
<ul>
<li>To install this package with Visual Studio 2017, right-click on the project and select <strong>Manage NuGet Packages</strong>.</li>
<li><p>To install with .NET Core CLI, execute the following in your project directory:</p>
<p><code>dotnet add package Microsoft.AspNetCore.Authentication.Google</code></p>
</li>
</ul>
<div class="tabGroup" id="tabgroup_+H0u2wFuvS">
<ul role="tablist">
<li role="presentation">
<a href="#tabpanel_+H0u2wFuvS_aspnetcore2x" role="tab" aria-controls="tabpanel_+H0u2wFuvS_aspnetcore2x" data-tab="aspnetcore2x" tabindex="0" aria-selected="true">ASP.NET Core 2.x</a>
</li>
<li role="presentation">
<a href="#tabpanel_+H0u2wFuvS_aspnetcore1x" role="tab" aria-controls="tabpanel_+H0u2wFuvS_aspnetcore1x" data-tab="aspnetcore1x" tabindex="-1">ASP.NET Core 1.x</a>
</li>
</ul>
<section id="tabpanel_+H0u2wFuvS_aspnetcore2x" role="tabpanel" data-tab="aspnetcore2x">
<p>Add the Google service in the <code>ConfigureServices</code> method in <em>Startup.cs</em> file:</p>
<pre><code class="lang-csharp">services.AddIdentity&lt;ApplicationUser, IdentityRole&gt;()
        .AddEntityFrameworkStores&lt;ApplicationDbContext&gt;()
        .AddDefaultTokenProviders();

services.AddAuthentication().AddGoogle(googleOptions =&gt;
{
    googleOptions.ClientId = Configuration[&quot;Authentication:Google:ClientId&quot;];
    googleOptions.ClientSecret = Configuration[&quot;Authentication:Google:ClientSecret&quot;];
});
</code></pre><p><strong>Note:</strong> The call to <code>AddIdentity</code> configures the default scheme settings. The <code>AddAuthentication(string defaultScheme)</code> overload sets the <code>DefaultScheme</code> property; and, the <code>AddAuthentication(Action&lt;AuthenticationOptions&gt; configureOptions)</code> overload sets only the properties you explicitly set. Either of these overloads should only be called once when adding multiple authentication providers. Subsequent calls to it have the potential of overriding any previously configured <a href="https://docs.microsoft.com/aspnet/core/api/microsoft.aspnetcore.builder.authenticationoptions">AuthenticationOptions</a> properties.</p>
</section>
<section id="tabpanel_+H0u2wFuvS_aspnetcore1x" role="tabpanel" data-tab="aspnetcore1x" aria-hidden="true" hidden="hidden">
<p>Add the Google middleware in the <code>Configure</code> method in <em>Startup.cs</em> file:</p>
<pre><code class="lang-csharp">app.UseGoogleAuthentication(new GoogleOptions()
{
    ClientId = Configuration[&quot;Authentication:Google:ClientId&quot;],
    ClientSecret = Configuration[&quot;Authentication:Google:ClientSecret&quot;]
});
</code></pre></section>
</div>
<p>See the <a href="https://docs.microsoft.com/aspnet/core/api/microsoft.aspnetcore.builder.googleoptions">GoogleOptions</a> API reference for more information on configuration options supported by Google authentication. This can be used to request different information about the user.</p>
<h2 id="sign-in-with-google">Sign in with Google</h2>
<p>Run your application and click <strong>Log in</strong>. An option to sign in with Google appears:</p>
<p><img src="index/_static/DoneGoogle.png" alt="Web application running in Microsoft Edge: User not authenticated"></p>
<p>When you click on Google, you are redirected to Google for authentication:</p>
<p><img src="index/_static/GoogleLogin.png" alt="Google authentication dialog"></p>
<p>After entering your Google credentials, then you are redirected back to the web site where you can set your email.</p>
<p>You are now logged in using your Google credentials:</p>
<p><img src="index/_static/Done.png" alt="Web application running in Microsoft Edge: User authenticated"></p>
<h2 id="troubleshooting">Troubleshooting</h2>
<ul>
<li>If you receive a <code>403 (Forbidden)</code> error page from your own app when running in development mode (or break into the debugger with the same error), ensure that <strong>Google+ API</strong> has been enabled in the <strong>API Manager Library</strong> by following the steps listed <a href="#create-the-app-in-google-api-console">earlier on this page</a>. If the sign in doesn&#39;t work and you aren&#39;t getting any errors, switch to development mode to make the issue easier to debug.</li>
<li><strong>ASP.NET Core 2.x only:</strong> If Identity is not configured by calling <code>services.AddIdentity</code> in <code>ConfigureServices</code>, attempting to authenticate will result in <em>ArgumentException: The &#39;SignInScheme&#39; option must be provided</em>. The project template used in this tutorial ensures that this is done.</li>
<li>If the site database has not been created by applying the initial migration, you will get <em>A database operation failed while processing the request</em> error. Tap <strong>Apply Migrations</strong> to create the database and refresh to continue past the error.</li>
</ul>
<h2 id="next-steps">Next steps</h2>
<ul>
<li><p>This article showed how you can authenticate with Google. You can follow a similar approach to authenticate with other providers listed on the <a href="index.html">previous page</a>.</p>
</li>
<li><p>Once you publish your web site to Azure web app, you should reset the <code>ClientSecret</code> in the Google API Console.</p>
</li>
<li><p>Set the <code>Authentication:Google:ClientId</code> and <code>Authentication:Google:ClientSecret</code> as application settings in the Azure portal. The configuration system is set up to read keys from environment variables.</p>
</li>
</ul>
</article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                  <li>
                    <a href="https://github.com/aspnet/Docs/blob/w/riande/RP-EF/aspnetcore/security/authentication/social/google-logins.md/#L1" class="contribution-link">Improve this Doc</a>
                  </li>
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              <!-- <p><a class="back-to-top" href="#top">Back to top</a><p> -->
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            
            <span>Copyright © 2015-2017 Microsoft<br>Generated by <strong>DocFX</strong></span>
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../../../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../../styles/main.js"></script>
  </body>
</html>
