<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Microsoft Account external login setup </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Microsoft Account external login setup ">
    <meta name="generator" content="docfx 2.24.0.0">
    
    <link rel="shortcut icon" href="../../../favicon.ico">
    <link rel="stylesheet" href="../../../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../../../styles/docfx.css">
    <link rel="stylesheet" href="../../../styles/main.css">
    <meta property="docfx:navrel" content="/foo">
    <meta property="docfx:tocrel" content="../../../toc.html">
    
    
    
  </head>
  <body data-spy="scroll" data-target="#affix">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../../../index.html">
                <img id="logo" class="svg" src="../../../logo.svg" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div role="main" class="container body-content hide-when-search">
        
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="security/authentication/microsoft-logins">
<h1 id="configuring-microsoft-account-authentication">Configuring Microsoft Account authentication</h1>

<p><a name="security-authentication-microsoft-logins"></a></p>
<p>By <a href="https://github.com/01binary">Valeriy Novytskyy</a> and <a href="https://twitter.com/RickAndMSFT">Rick Anderson</a></p>
<p>This tutorial shows you how to enable your users to sign in with their Microsoft account using a sample ASP.NET Core 2.0 project created on the <a href="index.html">previous page</a>.</p>
<h2 id="create-the-app-in-microsoft-developer-portal">Create the app in Microsoft Developer Portal</h2>
<ul>
<li>Navigate to <a href="https://apps.dev.microsoft.com">https://apps.dev.microsoft.com</a> and create or sign into a Microsoft account:</li>
</ul>
<p><img src="index/_static/MicrosoftDevLogin.png" alt="Sign in dialog"></p>
<p>If you don&#39;t already have a Microsoft account, tap <strong><a href="https://signup.live.com/signup?wa=wsignin1.0&amp;rpsnv=13&amp;ct=1478151035&amp;rver=6.7.6643.0&amp;wp=SAPI_LONG&amp;wreply=https%3a%2f%2fapps.dev.microsoft.com%2fLoginPostBack&amp;id=293053&amp;aadredir=1&amp;contextid=D70D4F21246BAB50&amp;bk=1478151036&amp;uiflavor=web&amp;uaid=f0c3de863a914c358b8dc01b1ff49e85&amp;mkt=EN-US&amp;lc=1033&amp;lic=1">Create one!</a></strong> After signing in you are redirected to <strong>My applications</strong> page:</p>
<p><img src="index/_static/MicrosoftDev.png" alt="Microsoft Developer Portal open in Microsoft Edge"></p>
<ul>
<li>Tap <strong>Add an app</strong> in the upper right corner and enter your <strong>Application Name</strong> and <strong>Contact Email</strong>:</li>
</ul>
<p><img src="index/_static/MicrosoftDevAppCreate.png" alt="New Application Registration dialog"></p>
<ul>
<li><p>For the purposes of this tutorial, clear the <strong>Guided Setup</strong> check box.</p>
</li>
<li><p>Tap <strong>Create</strong> to continue to the <strong>Registration</strong> page. Provide a <strong>Name</strong> and note the value of the <strong>Application Id</strong>, which you use as <code>ClientId</code> later in the tutorial:</p>
</li>
</ul>
<p><img src="index/_static/MicrosoftDevAppReg.png" alt="Registration page"></p>
<ul>
<li>Tap <strong>Add Platform</strong> in the <strong>Platforms</strong> section and select the <strong>Web</strong> platform:</li>
</ul>
<p><img src="index/_static/MicrosoftDevAppPlatform.png" alt="Add Platform dialog"></p>
<ul>
<li>In the new <strong>Web</strong> platform section, enter your development URL with <em>/signin-microsoft</em> appended into the <strong>Redirect URLs</strong> field (for example: <code>https://localhost:44320/signin-microsoft</code>). The Microsoft authentication scheme configured later in this tutorial will automatically handle requests at <em>/signin-microsoft</em> route to implement the OAuth flow:</li>
</ul>
<p><img src="index/_static/MicrosoftRedirectUri.png" alt="Web Platform section"></p>
<ul>
<li><p>Tap <strong>Add URL</strong> to ensure the URL was added.</p>
</li>
<li><p>Fill out any other application settings if necessary and tap <strong>Save</strong> at the bottom of the page to save changes to app configuration.</p>
</li>
<li><p>When deploying the site you&#39;ll need to revisit the <strong>Registration</strong> page and set a new public URL.</p>
</li>
</ul>
<h2 id="store-microsoft-application-id-and-password">Store Microsoft Application Id and Password</h2>
<ul>
<li><p>Note the <code>Application Id</code> displayed on the <strong>Registration</strong> page.</p>
</li>
<li><p>Tap <strong>Generate New Password</strong> in the <strong>Application Secrets</strong> section. This displays a box where you can copy the application password:</p>
</li>
</ul>
<p><img src="index/_static/MicrosoftDevPassword.png" alt="New password generated dialog"></p>
<p>Link sensitive settings like Microsoft <code>Application ID</code> and <code>Password</code> to your application configuration using the <a href="../../app-secrets.html">Secret Manager</a>. For the purposes of this tutorial, name the tokens <code>Authentication:Microsoft:ApplicationId</code> and <code>Authentication:Microsoft:Password</code>.</p>
<h2 id="configure-microsoft-account-authentication">Configure Microsoft Account Authentication</h2>
<p>The project template used in this tutorial ensures that <a href="https://www.nuget.org/packages/Microsoft.AspNetCore.Authentication.MicrosoftAccount">Microsoft.AspNetCore.Authentication.MicrosoftAccount</a> package is already installed.</p>
<ul>
<li>To install this package with Visual Studio 2017, right-click on the project and select <strong>Manage NuGet Packages</strong>.</li>
<li><p>To install with .NET Core CLI, execute the following in your project directory:</p>
<p> <code>dotnet add package Microsoft.AspNetCore.Authentication.MicrosoftAccount</code></p>
</li>
</ul>
<div class="tabGroup" id="tabgroup_CBMl9DXDzQ">
<ul role="tablist">
<li role="presentation">
<a href="#tabpanel_CBMl9DXDzQ_aspnetcore2x" role="tab" aria-controls="tabpanel_CBMl9DXDzQ_aspnetcore2x" data-tab="aspnetcore2x" tabindex="0" aria-selected="true">ASP.NET Core 2.x</a>
</li>
<li role="presentation">
<a href="#tabpanel_CBMl9DXDzQ_aspnetcore1x" role="tab" aria-controls="tabpanel_CBMl9DXDzQ_aspnetcore1x" data-tab="aspnetcore1x" tabindex="-1">ASP.NET Core 1.x</a>
</li>
</ul>
<section id="tabpanel_CBMl9DXDzQ_aspnetcore2x" role="tabpanel" data-tab="aspnetcore2x">
<p>Add the Microsoft Account service in the <code>ConfigureServices</code> method in <em>Startup.cs</em> file:</p>
<pre><code class="lang-csharp">services.AddIdentity&lt;ApplicationUser, IdentityRole&gt;()
        .AddEntityFrameworkStores&lt;ApplicationDbContext&gt;()
        .AddDefaultTokenProviders();

services.AddAuthentication().AddMicrosoftAccount(microsoftOptions =&gt;
{
    microsoftOptions.ClientId = Configuration[&quot;Authentication:Microsoft:ApplicationId&quot;];
    microsoftOptions.ClientSecret = Configuration[&quot;Authentication:Microsoft:Password&quot;];
});
</code></pre><p><strong>Note:</strong> The call to <code>AddIdentity</code> configures the default scheme settings. The <code>AddAuthentication(string defaultScheme)</code> overload sets the <code>DefaultScheme</code> property; and, the <code>AddAuthentication(Action&lt;AuthenticationOptions&gt; configureOptions)</code> overload sets only the properties you explicitly set. Either of these overloads should only be called once when adding multiple authentication providers. Subsequent calls to it have the potential of overriding any previously configured <a href="https://docs.microsoft.com/aspnet/core/api/microsoft.aspnetcore.builder.authenticationoptions">AuthenticationOptions</a> properties.</p>
</section>
<section id="tabpanel_CBMl9DXDzQ_aspnetcore1x" role="tabpanel" data-tab="aspnetcore1x" aria-hidden="true" hidden="hidden">
<p>Add the Microsoft Account middleware in the <code>Configure</code> method in <em>Startup.cs</em> file:</p>
<pre><code class="lang-csharp">app.UseMicrosoftAccountAuthentication(new MicrosoftAccountOptions()
{
    ClientId = Configuration[&quot;Authentication:Microsoft:ApplicationId&quot;],
    ClientSecret = Configuration[&quot;Authentication:Microsoft:Password&quot;]
});
</code></pre></section>
</div>
<p>Although the terminology used on Microsoft Developer Portal names these tokens <code>ApplicationId</code> and <code>Password</code>, they are exposed as <code>ClientId</code> and <code>ClientSecret</code> to the configuration API.</p>
<p>See the <a href="https://docs.microsoft.com/aspnet/core/api/microsoft.aspnetcore.builder.microsoftaccountoptions">MicrosoftAccountOptions</a> API reference for more information on configuration options supported by Microsoft Account authentication. This can be used to request different information about the user.</p>
<h2 id="sign-in-with-microsoft-account">Sign in with Microsoft Account</h2>
<p>Run your application and click <strong>Log in</strong>. An option to sign in with Microsoft appears:</p>
<p><img src="index/_static/DoneMicrosoft.png" alt="Web application Log in page: User not authenticated"></p>
<p>When you click on Microsoft, you are redirected to Microsoft for authentication. After signing in with your Microsoft Account (if not already signed in) you will be prompted to let the app access your info:</p>
<p><img src="index/_static/MicrosoftLogin.png" alt="Microsoft authentication dialog"></p>
<p>Tap <strong>Yes</strong> and you will be redirected back to the web site where you can set your email.</p>
<p>You are now logged in using your Microsoft credentials:</p>
<p><img src="index/_static/Done.png" alt="Web application: User authenticated"></p>
<h2 id="troubleshooting">Troubleshooting</h2>
<ul>
<li><p>If the Microsoft Account provider redirects you to a sign in error page, note the error title and description query string parameters directly following the <code>#</code> (hashtag) in the Uri.</p>
<p>Although the error message seems to indicate a problem with Microsoft authentication, the most common cause is your application Uri not matching any of the <strong>Redirect URIs</strong> specified for the <strong>Web</strong> platform.</p>
</li>
<li><strong>ASP.NET Core 2.x only:</strong> If Identity is not configured by calling <code>services.AddIdentity</code> in <code>ConfigureServices</code>, attempting to authenticate will result in <em>ArgumentException: The &#39;SignInScheme&#39; option must be provided</em>. The project template used in this tutorial ensures that this is done.</li>
<li>If the site database has not been created by applying the initial migration, you will get <em>A database operation failed while processing the request</em> error. Tap <strong>Apply Migrations</strong> to create the database and refresh to continue past the error.</li>
</ul>
<h2 id="next-steps">Next steps</h2>
<ul>
<li><p>This article showed how you can authenticate with Microsoft. You can follow a similar approach to authenticate with other providers listed on the <a href="index.html">previous page</a>.</p>
</li>
<li><p>Once you publish your web site to Azure web app, you should create a new <code>Password</code> in the Microsoft Developer Portal.</p>
</li>
<li><p>Set the <code>Authentication:Microsoft:ApplicationId</code> and <code>Authentication:Microsoft:Password</code> as application settings in the Azure portal. The configuration system is set up to read keys from environment variables.</p>
</li>
</ul>
</article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                  <li>
                    <a href="https://github.com/aspnet/Docs/blob/w/riande/RP-EF/aspnetcore/security/authentication/social/microsoft-logins.md/#L1" class="contribution-link">Improve this Doc</a>
                  </li>
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              <!-- <p><a class="back-to-top" href="#top">Back to top</a><p> -->
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            
            <span>Copyright © 2015-2017 Microsoft<br>Generated by <strong>DocFX</strong></span>
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../../../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../../styles/main.js"></script>
  </body>
</html>
