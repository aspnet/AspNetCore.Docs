<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>ASP.NET Core MVC with EF Core - Concurrency - 8 of 10 </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="ASP.NET Core MVC with EF Core - Concurrency - 8 of 10 ">
    <meta name="generator" content="docfx 2.24.0.0">
    
    <link rel="shortcut icon" href="../../favicon.ico">
    <link rel="stylesheet" href="../../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../../styles/docfx.css">
    <link rel="stylesheet" href="../../styles/main.css">
    <meta property="docfx:navrel" content="/foo">
    <meta property="docfx:tocrel" content="../../toc.html">
    
    
    
  </head>
  <body data-spy="scroll" data-target="#affix">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../../index.html">
                <img id="logo" class="svg" src="../../logo.svg" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div role="main" class="container body-content hide-when-search">
        
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="data/ef-mvc/concurrency">
<h1 id="handling-concurrency-conflicts---ef-core-with-aspnet-core-mvc-tutorial-8-of-10">Handling concurrency conflicts - EF Core with ASP.NET Core MVC tutorial (8 of 10)</h1>

<p>By <a href="https://github.com/tdykstra">Tom Dykstra</a> and <a href="https://twitter.com/RickAndMSFT">Rick Anderson</a></p>
<p>The Contoso University sample web application demonstrates how to create ASP.NET Core MVC web applications using Entity Framework Core and Visual Studio. For information about the tutorial series, see <a href="intro.html">the first tutorial in the series</a>.</p>
<p>In earlier tutorials, you learned how to update data. This tutorial shows how to handle conflicts when multiple users update the same entity at the same time.</p>
<p>You&#39;ll create web pages that work with the Department entity and handle concurrency errors. The following illustrations show the Edit and Delete pages, including some messages that are displayed if a concurrency conflict occurs.</p>
<p><img src="concurrency/_static/edit-error.png" alt="Department Edit page"></p>
<p><img src="concurrency/_static/delete-error.png" alt="Department Delete page"></p>
<h2 id="concurrency-conflicts">Concurrency conflicts</h2>
<p>A concurrency conflict occurs when one user displays an entity&#39;s data in order to edit it, and then another user updates the same entity&#39;s data before the first user&#39;s change is written to the database. If you don&#39;t enable the detection of such conflicts, whoever updates the database last overwrites the other user&#39;s changes. In many applications, this risk is acceptable: if there are few users, or few updates, or if isn&#39;t really critical if some changes are overwritten, the cost of programming for concurrency might outweigh the benefit. In that case, you don&#39;t have to configure the application to handle concurrency conflicts.</p>
<h3 id="pessimistic-concurrency-locking">Pessimistic concurrency (locking)</h3>
<p>If your application does need to prevent accidental data loss in concurrency scenarios, one way to do that is to use database locks. This is called pessimistic concurrency. For example, before you read a row from a database, you request a lock for read-only or for update access. If you lock a row for update access, no other users are allowed to lock the row either for read-only or update access, because they would get a copy of data that&#39;s in the process of being changed. If you lock a row for read-only access, others can also lock it for read-only access but not for update.</p>
<p>Managing locks has disadvantages. It can be complex to program. It requires significant database management resources, and it can cause performance problems as the number of users of an application increases. For these reasons, not all database management systems support pessimistic concurrency. Entity Framework Core provides no built-in support for it, and this tutorial doesn&#39;t show you how to implement it.</p>
<h3 id="optimistic-concurrency">Optimistic Concurrency</h3>
<p>The alternative to pessimistic concurrency is optimistic concurrency. Optimistic concurrency means allowing concurrency conflicts to happen, and then reacting appropriately if they do. For example, Jane visits the Department Edit page and changes the Budget amount for the English department from $350,000.00 to $0.00.</p>
<p><img src="concurrency/_static/change-budget.png" alt="Changing budget to 0"></p>
<p>Before Jane clicks <strong>Save</strong>, John visits the same page and changes the Start Date field from 9/1/2007 to 9/1/2013.</p>
<p><img src="concurrency/_static/change-date.png" alt="Changing start date to 2013"></p>
<p>Jane clicks <strong>Save</strong> first and sees her change when the browser returns to the Index page.</p>
<p><img src="concurrency/_static/budget-zero.png" alt="Budget changed to zero"></p>
<p>Then John clicks <strong>Save</strong> on an Edit page that still shows a budget of $350,000.00. What happens next is determined by how you handle concurrency conflicts.</p>
<p>Some of the options include the following:</p>
<ul>
<li><p>You can keep track of which property a user has modified and update only the corresponding columns in the database.</p>
<p>   In the example scenario, no data would be lost, because different properties were updated by the two users. The next time someone browses the English department, they&#39;ll see both Jane&#39;s and John&#39;s changes -- a start date of 9/1/2013 and a budget of zero dollars. This method of updating can reduce the number of conflicts that could result in data loss, but it can&#39;t avoid data loss if competing changes are made to the same property of an entity. Whether the Entity Framework works this way depends on how you implement your update code. It&#39;s often not practical in a web application, because it can require that you maintain large amounts of state in order to keep track of all original property values for an entity as well as new values. Maintaining large amounts of state can affect application performance because it either requires server resources or must be included in the web page itself (for example, in hidden fields) or in a cookie.</p>
</li>
<li><p>You can let John&#39;s change overwrite Jane&#39;s change.</p>
<p>   The next time someone browses the English department, they&#39;ll see 9/1/2013 and the restored $350,000.00 value. This is called a <em>Client Wins</em> or <em>Last in Wins</em> scenario. (All values from the client take precedence over what&#39;s in the data store.) As noted in the introduction to this section, if you don&#39;t do any coding for concurrency handling, this will happen automatically.</p>
</li>
<li><p>You can prevent John&#39;s change from being updated in the database.</p>
<p>   Typically, you would display an error message, show him the current state of the data, and allow him to reapply his changes if he still wants to make them. This is called a <em>Store Wins</em> scenario. (The data-store values take precedence over the values submitted by the client.) You&#39;ll implement the Store Wins scenario in this tutorial. This method ensures that no changes are overwritten without a user being alerted to what&#39;s happening.</p>
</li>
</ul>
<h3 id="detecting-concurrency-conflicts">Detecting concurrency conflicts</h3>
<p>You can resolve conflicts by handling <code>DbConcurrencyException</code> exceptions that the Entity Framework throws. In order to know when to throw these exceptions, the Entity Framework must be able to detect conflicts. Therefore, you must configure the database and the data model appropriately. Some options for enabling conflict detection include the following:</p>
<ul>
<li><p>In the database table, include a tracking column that can be used to determine when a row has been changed. You can then configure the Entity Framework to include that column in the Where clause of SQL Update or Delete commands.</p>
<p>   The data type of the tracking column is typically <code>rowversion</code>. The <code>rowversion</code> value is a sequential number that&#39;s incremented each time the row is updated. In an Update or Delete command, the Where clause includes the original value of the tracking column (the original row version) . If the row being updated has been changed by another user, the value in the <code>rowversion</code> column is different than the original value, so the Update or Delete statement can&#39;t find the row to update because of the Where clause. When the Entity Framework finds that no rows have been updated by the Update or Delete command (that is, when the number of affected rows is zero), it interprets that as a concurrency conflict.</p>
</li>
<li><p>Configure the Entity Framework to include the original values of every column in the table in the Where clause of Update and Delete commands.</p>
<p>   As in the first option, if anything in the row has changed since the row was first read, the Where clause won&#39;t return a row to update, which the Entity Framework interprets as a concurrency conflict. For database tables that have many columns, this approach can result in very large Where clauses, and can require that you maintain large amounts of state. As noted earlier, maintaining large amounts of state can affect application performance. Therefore this approach is generally not recommended, and it isn&#39;t the method used in this tutorial.</p>
<p>   If you do want to implement this approach to concurrency, you have to mark all non-primary-key properties in the entity you want to track concurrency for by adding the <code>ConcurrencyCheck</code> attribute to them. That change enables the Entity Framework to include all columns in the SQL Where clause of Update and Delete statements.</p>
</li>
</ul>
<p>In the remainder of this tutorial you&#39;ll add a <code>rowversion</code> tracking property to the Department entity, create a controller and views, and test to verify that everything works correctly.</p>
<h2 id="add-a-tracking-property-to-the-department-entity">Add a tracking property to the Department entity</h2>
<p>In <em>Models/Department.cs</em>, add a tracking property named RowVersion:</p>
<pre><code class="lang-csharp" name="Main" highlight-lines="26,27">using System;
using System.Collections.Generic;
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace ContosoUniversity.Models
{
    public class Department
    {
        public int DepartmentID { get; set; }

        [StringLength(50, MinimumLength = 3)]
        public string Name { get; set; }

        [DataType(DataType.Currency)]
        [Column(TypeName = &quot;money&quot;)]
        public decimal Budget { get; set; }

        [DataType(DataType.Date)]
        [DisplayFormat(DataFormatString = &quot;{0:yyyy-MM-dd}&quot;, ApplyFormatInEditMode = true)]
        [Display(Name = &quot;Start Date&quot;)]
        public DateTime StartDate { get; set; }

        public int? InstructorID { get; set; }

        [Timestamp]
        public byte[] RowVersion { get; set; }

        public Instructor Administrator { get; set; }
        public ICollection&lt;Course&gt; Courses { get; set; }
    }
}
</code></pre><p>The <code>Timestamp</code> attribute specifies that this column will be included in the Where clause of Update and Delete commands sent to the database. The attribute is called <code>Timestamp</code> because previous versions of SQL Server used a SQL <code>timestamp</code> data type before the SQL <code>rowversion</code> replaced it. The .NET type for <code>rowversion</code> is a byte array.</p>
<p>If you prefer to use the fluent API, you can use the <code>IsConcurrencyToken</code> method (in <em>Data/SchoolContext.cs</em>) to specify the tracking property, as shown in the following example:</p>
<pre><code class="lang-csharp">modelBuilder.Entity&lt;Department&gt;()
    .Property(p =&gt; p.RowVersion).IsConcurrencyToken();
</code></pre><p>By adding a property you changed the database model, so you need to do another migration.</p>
<p>Save your changes and build the project, and then enter the following commands in the command window:</p>
<pre><code class="lang-console">dotnet ef migrations add RowVersion
</code></pre><pre><code class="lang-console">dotnet ef database update
</code></pre><h2 id="create-a-departments-controller-and-views">Create a Departments controller and views</h2>
<p>Scaffold a Departments controller and views as you did earlier for Students, Courses, and Instructors.</p>
<p><img src="concurrency/_static/add-departments-controller.png" alt="Scaffold Department"></p>
<p>In the <em>DepartmentsController.cs</em> file, change all four occurrences of &quot;FirstMidName&quot; to &quot;FullName&quot; so that the department administrator drop-down lists will contain the full name of the instructor rather than just the last name.</p>
<pre><code class="lang-csharp" name="Main">ViewData[&quot;InstructorID&quot;] = new SelectList(_context.Instructors, &quot;ID&quot;, &quot;FullName&quot;, department.InstructorID);
</code></pre><h2 id="update-the-departments-index-view">Update the Departments Index view</h2>
<p>The scaffolding engine created a RowVersion column in the Index view, but that field shouldn&#39;t be displayed.</p>
<p>Replace the code in <em>Views/Departments/Index.cshtml</em> with the following code.</p>
<pre><code class="lang-html" name="Main" highlight-lines="4,7,44">@model IEnumerable&lt;ContosoUniversity.Models.Department&gt;

@{
    ViewData[&quot;Title&quot;] = &quot;Departments&quot;;
}

&lt;h2&gt;Departments&lt;/h2&gt;

&lt;p&gt;
    &lt;a asp-action=&quot;Create&quot;&gt;Create New&lt;/a&gt;
&lt;/p&gt;
&lt;table class=&quot;table&quot;&gt;
    &lt;thead&gt;
        &lt;tr&gt;
            &lt;th&gt;
                @Html.DisplayNameFor(model =&gt; model.Name)
            &lt;/th&gt;
            &lt;th&gt;
                @Html.DisplayNameFor(model =&gt; model.Budget)
            &lt;/th&gt;
            &lt;th&gt;
                @Html.DisplayNameFor(model =&gt; model.StartDate)
            &lt;/th&gt;
            &lt;th&gt;
                @Html.DisplayNameFor(model =&gt; model.Administrator)
            &lt;/th&gt;
            &lt;th&gt;&lt;/th&gt;
        &lt;/tr&gt;
    &lt;/thead&gt;
    &lt;tbody&gt;
        @foreach (var item in Model)
        {
            &lt;tr&gt;
                &lt;td&gt;
                    @Html.DisplayFor(modelItem =&gt; item.Name)
                &lt;/td&gt;
                &lt;td&gt;
                    @Html.DisplayFor(modelItem =&gt; item.Budget)
                &lt;/td&gt;
                &lt;td&gt;
                    @Html.DisplayFor(modelItem =&gt; item.StartDate)
                &lt;/td&gt;
                &lt;td&gt;
                    @Html.DisplayFor(modelItem =&gt; item.Administrator.FullName)
                &lt;/td&gt;
                &lt;td&gt;
                    &lt;a asp-action=&quot;Edit&quot; asp-route-id=&quot;@item.DepartmentID&quot;&gt;Edit&lt;/a&gt; |
                    &lt;a asp-action=&quot;Details&quot; asp-route-id=&quot;@item.DepartmentID&quot;&gt;Details&lt;/a&gt; |
                    &lt;a asp-action=&quot;Delete&quot; asp-route-id=&quot;@item.DepartmentID&quot;&gt;Delete&lt;/a&gt;
                &lt;/td&gt;
            &lt;/tr&gt;
        }
    &lt;/tbody&gt;
&lt;/table&gt;
</code></pre><p>This changes the heading to &quot;Departments&quot;, deletes the RowVersion column, and shows full name instead of first name for the administrator.</p>
<h2 id="update-the-edit-methods-in-the-departments-controller">Update the Edit methods in the Departments controller</h2>
<p>In both the HttpGet <code>Edit</code> method and the <code>Details</code> method, add <code>AsNoTracking</code>. In the HttpGet <code>Edit</code> method, add eager loading for the Administrator.</p>
<pre><code class="lang-csharp" name="Main" highlight-lines="2,3">var department = await _context.Departments
    .Include(i =&gt; i.Administrator)
    .AsNoTracking()
    .SingleOrDefaultAsync(m =&gt; m.DepartmentID == id);
</code></pre><p>Replace the existing code for the HttpPost <code>Edit</code> method with the following code:</p>
<pre><code class="lang-csharp" name="Main">[HttpPost]
[ValidateAntiForgeryToken]
public async Task&lt;IActionResult&gt; Edit(int? id, byte[] rowVersion)
{
    if (id == null)
    {
        return NotFound();
    }

    var departmentToUpdate = await _context.Departments.Include(i =&gt; i.Administrator).SingleOrDefaultAsync(m =&gt; m.DepartmentID == id);

    if (departmentToUpdate == null)
    {
        Department deletedDepartment = new Department();
        await TryUpdateModelAsync(deletedDepartment);
        ModelState.AddModelError(string.Empty,
            &quot;Unable to save changes. The department was deleted by another user.&quot;);
        ViewData[&quot;InstructorID&quot;] = new SelectList(_context.Instructors, &quot;ID&quot;, &quot;FullName&quot;, deletedDepartment.InstructorID);
        return View(deletedDepartment);
    }

    _context.Entry(departmentToUpdate).Property(&quot;RowVersion&quot;).OriginalValue = rowVersion;

    if (await TryUpdateModelAsync&lt;Department&gt;(
        departmentToUpdate,
        &quot;&quot;,
        s =&gt; s.Name, s =&gt; s.StartDate, s =&gt; s.Budget, s =&gt; s.InstructorID))
    {
        try
        {
            await _context.SaveChangesAsync();
            return RedirectToAction(nameof(Index));
        }
        catch (DbUpdateConcurrencyException ex)
        {
            var exceptionEntry = ex.Entries.Single();
            var clientValues = (Department)exceptionEntry.Entity;
            var databaseEntry = exceptionEntry.GetDatabaseValues();
            if (databaseEntry == null)
            {
                ModelState.AddModelError(string.Empty,
                    &quot;Unable to save changes. The department was deleted by another user.&quot;);
            }
            else
            {
                var databaseValues = (Department)databaseEntry.ToObject();

                if (databaseValues.Name != clientValues.Name)
                {
                    ModelState.AddModelError(&quot;Name&quot;, $&quot;Current value: {databaseValues.Name}&quot;);
                }
                if (databaseValues.Budget != clientValues.Budget)
                {
                    ModelState.AddModelError(&quot;Budget&quot;, $&quot;Current value: {databaseValues.Budget:c}&quot;);
                }
                if (databaseValues.StartDate != clientValues.StartDate)
                {
                    ModelState.AddModelError(&quot;StartDate&quot;, $&quot;Current value: {databaseValues.StartDate:d}&quot;);
                }
                if (databaseValues.InstructorID != clientValues.InstructorID)
                {
                    Instructor databaseInstructor = await _context.Instructors.SingleOrDefaultAsync(i =&gt; i.ID == databaseValues.InstructorID);
                    ModelState.AddModelError(&quot;InstructorID&quot;, $&quot;Current value: {databaseInstructor?.FullName}&quot;);
                }

                ModelState.AddModelError(string.Empty, &quot;The record you attempted to edit &quot;
                        + &quot;was modified by another user after you got the original value. The &quot;
                        + &quot;edit operation was canceled and the current values in the database &quot;
                        + &quot;have been displayed. If you still want to edit this record, click &quot;
                        + &quot;the Save button again. Otherwise click the Back to List hyperlink.&quot;);
                departmentToUpdate.RowVersion = (byte[])databaseValues.RowVersion;
                ModelState.Remove(&quot;RowVersion&quot;);
            }
        }
    }
    ViewData[&quot;InstructorID&quot;] = new SelectList(_context.Instructors, &quot;ID&quot;, &quot;FullName&quot;, departmentToUpdate.InstructorID);
    return View(departmentToUpdate);
}
</code></pre><p>The code begins by trying to read the department to be updated. If the <code>SingleOrDefaultAsync</code> method returns null, the department was deleted by another user. In that case the code uses the posted form values to create a department entity so that the Edit page can be redisplayed with an error message. As an alternative, you wouldn&#39;t have to re-create the department entity if you display only an error message without redisplaying the department fields.</p>
<p>The view stores the original <code>RowVersion</code> value in a hidden field, and this method receives that value in the <code>rowVersion</code> parameter. Before you call <code>SaveChanges</code>, you have to put that original <code>RowVersion</code> property value in the <code>OriginalValues</code> collection for the entity.</p>
<pre><code class="lang-csharp">_context.Entry(departmentToUpdate).Property(&quot;RowVersion&quot;).OriginalValue = rowVersion;
</code></pre><p>Then when the Entity Framework creates a SQL UPDATE command, that command will include a WHERE clause that looks for a row that has the original <code>RowVersion</code> value. If no rows are affected by the UPDATE command (no rows have the original <code>RowVersion</code> value),  the Entity Framework throws a <code>DbUpdateConcurrencyException</code> exception.</p>
<p>The code in the catch block for that exception gets the affected Department entity that has the updated values from the <code>Entries</code> property on the exception object.</p>
<pre><code class="lang-csharp" name="Main">var exceptionEntry = ex.Entries.Single();
</code></pre><p>The <code>Entries</code> collection will have just one <code>EntityEntry</code> object.  You can use that object to get the new values entered by the user and the current database values.</p>
<pre><code class="lang-csharp" name="Main">var clientValues = (Department)exceptionEntry.Entity;
var databaseEntry = exceptionEntry.GetDatabaseValues();
</code></pre><p>The code adds a custom error message for each column that has database values different from what the user entered on the Edit page (only one field is shown here for brevity).</p>
<pre><code class="lang-csharp" name="Main">var databaseValues = (Department)databaseEntry.ToObject();

if (databaseValues.Name != clientValues.Name)
{
    ModelState.AddModelError(&quot;Name&quot;, $&quot;Current value: {databaseValues.Name}&quot;);
</code></pre><p>Finally, the code sets the <code>RowVersion</code> value of the <code>departmentToUpdate</code> to the new value retrieved from the database. This new <code>RowVersion</code> value will be stored in the hidden field when the Edit page is redisplayed, and the next time the user clicks <strong>Save</strong>, only concurrency errors that happen since the redisplay of the Edit page will be caught.</p>
<pre><code class="lang-csharp" name="Main">departmentToUpdate.RowVersion = (byte[])databaseValues.RowVersion;
ModelState.Remove(&quot;RowVersion&quot;);
</code></pre><p>The <code>ModelState.Remove</code> statement is required because <code>ModelState</code> has the old <code>RowVersion</code> value. In the view, the <code>ModelState</code> value for a field takes precedence over the model property values when both are present.</p>
<h2 id="update-the-department-edit-view">Update the Department Edit view</h2>
<p>In <em>Views/Departments/Edit.cshtml</em>, make the following changes:</p>
<ul>
<li><p>Add a hidden field to save the <code>RowVersion</code> property value, immediately following the hidden field for the <code>DepartmentID</code> property.</p>
</li>
<li><p>Add a &quot;Select Administrator&quot; option to the drop-down list.</p>
</li>
</ul>
<pre><code class="lang-html" name="Main" highlight-lines="16,34-36">@model ContosoUniversity.Models.Department

@{
    ViewData[&quot;Title&quot;] = &quot;Edit&quot;;
}

&lt;h2&gt;Edit&lt;/h2&gt;

&lt;h4&gt;Department&lt;/h4&gt;
&lt;hr /&gt;
&lt;div class=&quot;row&quot;&gt;
    &lt;div class=&quot;col-md-4&quot;&gt;
        &lt;form asp-action=&quot;Edit&quot;&gt;
            &lt;div asp-validation-summary=&quot;ModelOnly&quot; class=&quot;text-danger&quot;&gt;&lt;/div&gt;
            &lt;input type=&quot;hidden&quot; asp-for=&quot;DepartmentID&quot; /&gt;
            &lt;input type=&quot;hidden&quot; asp-for=&quot;RowVersion&quot; /&gt;
            &lt;div class=&quot;form-group&quot;&gt;
                &lt;label asp-for=&quot;Name&quot; class=&quot;control-label&quot;&gt;&lt;/label&gt;
                &lt;input asp-for=&quot;Name&quot; class=&quot;form-control&quot; /&gt;
                &lt;span asp-validation-for=&quot;Name&quot; class=&quot;text-danger&quot;&gt;&lt;/span&gt;
            &lt;/div&gt;
            &lt;div class=&quot;form-group&quot;&gt;
                &lt;label asp-for=&quot;Budget&quot; class=&quot;control-label&quot;&gt;&lt;/label&gt;
                &lt;input asp-for=&quot;Budget&quot; class=&quot;form-control&quot; /&gt;
                &lt;span asp-validation-for=&quot;Budget&quot; class=&quot;text-danger&quot;&gt;&lt;/span&gt;
            &lt;/div&gt;
            &lt;div class=&quot;form-group&quot;&gt;
                &lt;label asp-for=&quot;StartDate&quot; class=&quot;control-label&quot;&gt;&lt;/label&gt;
                &lt;input asp-for=&quot;StartDate&quot; class=&quot;form-control&quot; /&gt;
                &lt;span asp-validation-for=&quot;StartDate&quot; class=&quot;text-danger&quot;&gt;&lt;/span&gt;
            &lt;/div&gt;
            &lt;div class=&quot;form-group&quot;&gt;
                &lt;label asp-for=&quot;InstructorID&quot; class=&quot;control-label&quot;&gt;&lt;/label&gt;
                &lt;select asp-for=&quot;InstructorID&quot; class=&quot;form-control&quot; asp-items=&quot;ViewBag.InstructorID&quot;&gt;
                    &lt;option value=&quot;&quot;&gt;-- Select Administrator --&lt;/option&gt;
                &lt;/select&gt;
                &lt;span asp-validation-for=&quot;InstructorID&quot; class=&quot;text-danger&quot;&gt;&lt;/span&gt;
            &lt;/div&gt;
            &lt;div class=&quot;form-group&quot;&gt;
                &lt;input type=&quot;submit&quot; value=&quot;Save&quot; class=&quot;btn btn-default&quot; /&gt;
            &lt;/div&gt;
        &lt;/form&gt;
    &lt;/div&gt;
&lt;/div&gt;

&lt;div&gt;
    &lt;a asp-action=&quot;Index&quot;&gt;Back to List&lt;/a&gt;
&lt;/div&gt;

@section Scripts {
    @{await Html.RenderPartialAsync(&quot;_ValidationScriptsPartial&quot;);}
}
</code></pre><h2 id="test-concurrency-conflicts-in-the-edit-page">Test concurrency conflicts in the Edit page</h2>
<p>Run the app and go to the Departments Index page. Right-click the <strong>Edit</strong> hyperlink for the English department and select <strong>Open in new tab</strong>, then click the <strong>Edit</strong> hyperlink for the English department. The two browser tabs now display the same information.</p>
<p>Change a field in the first browser tab and click <strong>Save</strong>.</p>
<p><img src="concurrency/_static/edit-after-change-1.png" alt="Department Edit page 1 after change"></p>
<p>The browser shows the Index page with the changed value.</p>
<p>Change a field in the second browser tab.</p>
<p><img src="concurrency/_static/edit-after-change-2.png" alt="Department Edit page 2 after change"></p>
<p>Click <strong>Save</strong>. You see an error message:</p>
<p><img src="concurrency/_static/edit-error.png" alt="Department Edit page error message"></p>
<p>Click <strong>Save</strong> again. The value you entered in the second browser tab is saved. You see the saved values when the Index page appears.</p>
<h2 id="update-the-delete-page">Update the Delete page</h2>
<p>For the Delete page, the Entity Framework detects concurrency conflicts caused by someone else editing the department in a similar manner. When the HttpGet <code>Delete</code> method displays the confirmation view, the view includes the original <code>RowVersion</code> value in a hidden field. That value is then available to the HttpPost <code>Delete</code> method that&#39;s called when the user confirms the deletion. When the Entity Framework creates the SQL DELETE command, it includes a WHERE clause with the original <code>RowVersion</code> value. If the command results in zero rows affected (meaning the row was changed after the Delete confirmation page was displayed), a concurrency exception is thrown, and the HttpGet <code>Delete</code> method is called with an error flag set to true in order to redisplay the confirmation page with an error message. It&#39;s also possible that zero rows were affected because the row was deleted by another user, so in that case no error message is displayed.</p>
<h3 id="update-the-delete-methods-in-the-departments-controller">Update the Delete methods in the Departments controller</h3>
<p>In <em>DepartmentsController.cs</em>, replace the HttpGet <code>Delete</code> method with the following code:</p>
<pre><code class="lang-csharp" name="Main" highlight-lines="1,10,14-17,21-29">public async Task&lt;IActionResult&gt; Delete(int? id, bool? concurrencyError)
{
    if (id == null)
    {
        return NotFound();
    }

    var department = await _context.Departments
        .Include(d =&gt; d.Administrator)
        .AsNoTracking()
        .SingleOrDefaultAsync(m =&gt; m.DepartmentID == id);
    if (department == null)
    {
        if (concurrencyError.GetValueOrDefault())
        {
            return RedirectToAction(nameof(Index));
        }
        return NotFound();
    }

    if (concurrencyError.GetValueOrDefault())
    {
        ViewData[&quot;ConcurrencyErrorMessage&quot;] = &quot;The record you attempted to delete &quot;
            + &quot;was modified by another user after you got the original values. &quot;
            + &quot;The delete operation was canceled and the current values in the &quot;
            + &quot;database have been displayed. If you still want to delete this &quot;
            + &quot;record, click the Delete button again. Otherwise &quot;
            + &quot;click the Back to List hyperlink.&quot;;
    }

    return View(department);
}
</code></pre><p>The method accepts an optional parameter that indicates whether the page is being redisplayed after a concurrency error. If this flag is true and the department specified no longer exists, it was deleted by another user. In that case, the code redirects to the Index page.  If this flag is true and the Department does exist, it was changed by another user. In that case, the code sends an error message to the view using <code>ViewData</code>.  </p>
<p>Replace the code in the HttpPost <code>Delete</code> method (named <code>DeleteConfirmed</code>) with the following code:</p>
<pre><code class="lang-csharp" name="Main" highlight-lines="1,3,5-8,11-18">[HttpPost]
[ValidateAntiForgeryToken]
public async Task&lt;IActionResult&gt; Delete(Department department)
{
    try
    {
        if (await _context.Departments.AnyAsync(m =&gt; m.DepartmentID == department.DepartmentID))
        {
            _context.Departments.Remove(department);
            await _context.SaveChangesAsync();
        }
        return RedirectToAction(nameof(Index));
    }
    catch (DbUpdateConcurrencyException /* ex */)
    {
        //Log the error (uncomment ex variable name and write a log.)
        return RedirectToAction(nameof(Delete), new { concurrencyError = true, id = department.DepartmentID });
    }
}
</code></pre><p>In the scaffolded code that you just replaced, this method accepted only a record ID:</p>
<pre><code class="lang-csharp">public async Task&lt;IActionResult&gt; DeleteConfirmed(int id)
</code></pre><p>You&#39;ve changed this parameter to a Department entity instance created by the model binder. This gives EF access to the RowVersion property value in addition to the record key.</p>
<pre><code class="lang-csharp">public async Task&lt;IActionResult&gt; Delete(Department department)
</code></pre><p>You have also changed the action method name from <code>DeleteConfirmed</code> to <code>Delete</code>. The scaffolded code used the name <code>DeleteConfirmed</code> to give the HttpPost method a unique signature. (The CLR requires overloaded methods to have different method parameters.) Now that the signatures are unique, you can stick with the MVC convention and use the same name for the HttpPost and HttpGet delete methods.</p>
<p>If the department is already deleted, the <code>AnyAsync</code> method returns false and the application just goes back to the Index method.</p>
<p>If a concurrency error is caught, the code redisplays the Delete confirmation page and provides a flag that indicates it should display a concurrency error message.</p>
<h3 id="update-the-delete-view">Update the Delete view</h3>
<p>In <em>Views/Departments/Delete.cshtml</em>, replace the scaffolded code with the following code that adds an error message field and hidden fields for the DepartmentID and RowVersion properties. The changes are highlighted.</p>
<pre><code class="lang-html" name="Main" highlight-lines="9,38,44,45,48">@model ContosoUniversity.Models.Department

@{
    ViewData[&quot;Title&quot;] = &quot;Delete&quot;;
}

&lt;h2&gt;Delete&lt;/h2&gt;

&lt;p class=&quot;text-danger&quot;&gt;@ViewData[&quot;ConcurrencyErrorMessage&quot;]&lt;/p&gt;

&lt;h3&gt;Are you sure you want to delete this?&lt;/h3&gt;
&lt;div&gt;
    &lt;h4&gt;Department&lt;/h4&gt;
    &lt;hr /&gt;
    &lt;dl class=&quot;dl-horizontal&quot;&gt;
        &lt;dt&gt;
            @Html.DisplayNameFor(model =&gt; model.Name)
        &lt;/dt&gt;
        &lt;dd&gt;
            @Html.DisplayFor(model =&gt; model.Name)
        &lt;/dd&gt;
        &lt;dt&gt;
            @Html.DisplayNameFor(model =&gt; model.Budget)
        &lt;/dt&gt;
        &lt;dd&gt;
            @Html.DisplayFor(model =&gt; model.Budget)
        &lt;/dd&gt;
        &lt;dt&gt;
            @Html.DisplayNameFor(model =&gt; model.StartDate)
        &lt;/dt&gt;
        &lt;dd&gt;
            @Html.DisplayFor(model =&gt; model.StartDate)
        &lt;/dd&gt;
        &lt;dt&gt;
            @Html.DisplayNameFor(model =&gt; model.Administrator)
        &lt;/dt&gt;
        &lt;dd&gt;
            @Html.DisplayFor(model =&gt; model.Administrator.FullName)
        &lt;/dd&gt;
    &lt;/dl&gt;
    
    &lt;form asp-action=&quot;Delete&quot;&gt;
        &lt;input type=&quot;hidden&quot; asp-for=&quot;DepartmentID&quot; /&gt;
        &lt;input type=&quot;hidden&quot; asp-for=&quot;RowVersion&quot; /&gt;
        &lt;div class=&quot;form-actions no-color&quot;&gt;
            &lt;input type=&quot;submit&quot; value=&quot;Delete&quot; class=&quot;btn btn-default&quot; /&gt; |
            &lt;a asp-action=&quot;Index&quot;&gt;Back to List&lt;/a&gt;
        &lt;/div&gt;
    &lt;/form&gt;
&lt;/div&gt;
</code></pre><p>This makes the following changes:</p>
<ul>
<li><p>Adds an error message between the <code>h2</code> and <code>h3</code> headings.</p>
</li>
<li><p>Replaces FirstMidName with FullName in the <strong>Administrator</strong> field.</p>
</li>
<li><p>Removes the RowVersion field.</p>
</li>
<li><p>Adds a hidden field for the <code>RowVersion</code> property.</p>
</li>
</ul>
<p>Run the app and go to the Departments Index page. Right-click the <strong>Delete</strong> hyperlink for the English department and select <strong>Open in new tab</strong>, then in the first tab click the <strong>Edit</strong> hyperlink for the English department.</p>
<p>In the first window, change one of the values, and click <strong>Save</strong>:</p>
<p><img src="concurrency/_static/edit-after-change-for-delete.png" alt="Department Edit page after change before delete"></p>
<p>In the second tab, click <strong>Delete</strong>. You see the concurrency error message, and the Department values are refreshed with what&#39;s currently in the database.</p>
<p><img src="concurrency/_static/delete-error.png" alt="Department Delete confirmation page with concurrency error"></p>
<p>If you click <strong>Delete</strong> again, you&#39;re redirected to the Index page, which shows that the department has been deleted.</p>
<h2 id="update-details-and-create-views">Update Details and Create views</h2>
<p>You can optionally clean up scaffolded code in the Details and Create views.</p>
<p>Replace the code in <em>Views/Departments/Details.cshtml</em> to delete the RowVersion column and show the full name of the Administrator.</p>
<pre><code class="lang-html" name="Main" highlight-lines="35">@model ContosoUniversity.Models.Department

@{
    ViewData[&quot;Title&quot;] = &quot;Details&quot;;
}

&lt;h2&gt;Details&lt;/h2&gt;

&lt;div&gt;
    &lt;h4&gt;Department&lt;/h4&gt;
    &lt;hr /&gt;
    &lt;dl class=&quot;dl-horizontal&quot;&gt;
        &lt;dt&gt;
            @Html.DisplayNameFor(model =&gt; model.Name)
        &lt;/dt&gt;
        &lt;dd&gt;
            @Html.DisplayFor(model =&gt; model.Name)
        &lt;/dd&gt;
        &lt;dt&gt;
            @Html.DisplayNameFor(model =&gt; model.Budget)
        &lt;/dt&gt;
        &lt;dd&gt;
            @Html.DisplayFor(model =&gt; model.Budget)
        &lt;/dd&gt;
        &lt;dt&gt;
            @Html.DisplayNameFor(model =&gt; model.StartDate)
        &lt;/dt&gt;
        &lt;dd&gt;
            @Html.DisplayFor(model =&gt; model.StartDate)
        &lt;/dd&gt;
        &lt;dt&gt;
            @Html.DisplayNameFor(model =&gt; model.Administrator)
        &lt;/dt&gt;
        &lt;dd&gt;
            @Html.DisplayFor(model =&gt; model.Administrator.FullName)
        &lt;/dd&gt;
    &lt;/dl&gt;
&lt;/div&gt;
&lt;div&gt;
    &lt;a asp-action=&quot;Edit&quot; asp-route-id=&quot;@Model.DepartmentID&quot;&gt;Edit&lt;/a&gt; |
    &lt;a asp-action=&quot;Index&quot;&gt;Back to List&lt;/a&gt;
&lt;/div&gt;
</code></pre><p>Replace the code in <em>Views/Departments/Create.cshtml</em> to add a Select option to the drop-down list.</p>
<pre><code class="lang-html" name="Main" highlight-lines="32-34">@model ContosoUniversity.Models.Department

@{
    ViewData[&quot;Title&quot;] = &quot;Create&quot;;
}

&lt;h2&gt;Create&lt;/h2&gt;

&lt;h4&gt;Department&lt;/h4&gt;
&lt;hr /&gt;
&lt;div class=&quot;row&quot;&gt;
    &lt;div class=&quot;col-md-4&quot;&gt;
        &lt;form asp-action=&quot;Create&quot;&gt;
            &lt;div asp-validation-summary=&quot;ModelOnly&quot; class=&quot;text-danger&quot;&gt;&lt;/div&gt;
            &lt;div class=&quot;form-group&quot;&gt;
                &lt;label asp-for=&quot;Name&quot; class=&quot;control-label&quot;&gt;&lt;/label&gt;
                &lt;input asp-for=&quot;Name&quot; class=&quot;form-control&quot; /&gt;
                &lt;span asp-validation-for=&quot;Name&quot; class=&quot;text-danger&quot;&gt;&lt;/span&gt;
            &lt;/div&gt;
            &lt;div class=&quot;form-group&quot;&gt;
                &lt;label asp-for=&quot;Budget&quot; class=&quot;control-label&quot;&gt;&lt;/label&gt;
                &lt;input asp-for=&quot;Budget&quot; class=&quot;form-control&quot; /&gt;
                &lt;span asp-validation-for=&quot;Budget&quot; class=&quot;text-danger&quot;&gt;&lt;/span&gt;
            &lt;/div&gt;
            &lt;div class=&quot;form-group&quot;&gt;
                &lt;label asp-for=&quot;StartDate&quot; class=&quot;control-label&quot;&gt;&lt;/label&gt;
                &lt;input asp-for=&quot;StartDate&quot; class=&quot;form-control&quot; /&gt;
                &lt;span asp-validation-for=&quot;StartDate&quot; class=&quot;text-danger&quot;&gt;&lt;/span&gt;
            &lt;/div&gt;
            &lt;div class=&quot;form-group&quot;&gt;
                &lt;label asp-for=&quot;InstructorID&quot; class=&quot;control-label&quot;&gt;&lt;/label&gt;
                &lt;select asp-for=&quot;InstructorID&quot; class=&quot;form-control&quot; asp-items=&quot;ViewBag.InstructorID&quot;&gt;
                    &lt;option value=&quot;&quot;&gt;-- Select Administrator --&lt;/option&gt;
                &lt;/select&gt;
            &lt;/div&gt;
            &lt;div class=&quot;form-group&quot;&gt;
                &lt;input type=&quot;submit&quot; value=&quot;Create&quot; class=&quot;btn btn-default&quot; /&gt;
            &lt;/div&gt;
        &lt;/form&gt;
    &lt;/div&gt;
&lt;/div&gt;

&lt;div&gt;
    &lt;a asp-action=&quot;Index&quot;&gt;Back to List&lt;/a&gt;
&lt;/div&gt;

@section Scripts {
    @{await Html.RenderPartialAsync(&quot;_ValidationScriptsPartial&quot;);}
}
</code></pre><h2 id="summary">Summary</h2>
<p>This completes the introduction to handling concurrency conflicts. For more information about how to handle concurrency in EF Core, see <a href="https://docs.microsoft.com/ef/core/saving/concurrency">Concurrency conflicts</a>. The next tutorial shows how to implement table-per-hierarchy inheritance for the Instructor and Student entities.</p>
<div class="step-by-step"><p><a href="update-related-data.html">Previous</a>
<a href="inheritance.html">Next</a>  </p>
</div>
</article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                  <li>
                    <a href="https://github.com/aspnet/Docs/blob/w/riande/RP-EF/aspnetcore/data/ef-mvc/concurrency.md/#L1" class="contribution-link">Improve this Doc</a>
                  </li>
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              <!-- <p><a class="back-to-top" href="#top">Back to top</a><p> -->
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            
            <span>Copyright © 2015-2017 Microsoft<br>Generated by <strong>DocFX</strong></span>
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../styles/main.js"></script>
  </body>
</html>
